{% extends "base.html" %}
{% block title %}Nurses - Admin{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Nurses</h3>
  <a href="{{ url_for('admin.add_nurse') }}" class="btn btn-primary">Add Nurse</a>
</div>

<table class="table table-striped">
  <thead>
    <tr>
      <th>#</th>
      <th>Name</th>
      <th>Email</th>
      <th>Department</th>
      <th>Active</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for nurse in nurses.items %}
    <tr>
      <td>{{ nurse.id }}</td>
      <td>{{ nurse.full_name }}</td>
      <td>{{ nurse.user.email }}</td>
      <td>{{ nurse.department or '-' }}</td>

      <td>
        <button type="button" class="btn btn-sm btn-outline-info assigned-doctors-btn" data-bs-toggle="popover"
          data-nurse-id="{{ nurse.id }}" title="Assigned doctors">
          {{ nurse.get_assigned_doctor_ids()|length }} doctors
        </button>
      </td>
      <td>{{ 'Yes' if nurse.is_active else 'No' }}</td>
      <td>
        <a href="{{ url_for('admin.edit_nurse', nurse_id=nurse.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
        <form action="{{ url_for('admin.delete_nurse', nurse_id=nurse.id) }}" method="post" style="display:inline"
          onsubmit="return confirm('Deactivate this nurse?');">
          <button class="btn btn-sm btn-outline-danger">Deactivate</button>
        </form>
        <a href="{{ url_for('admin.assign_doctor_to_nurse', nurse_id=nurse.id) }}"
          class="btn btn-sm btn-outline-info">Assign Doctors</a>
      </td>
    </tr>
    {% else %}
    <tr>
      <td colspan="6" class="text-center">No nurses found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<nav aria-label="Page navigation">
  <ul class="pagination">
    {% if nurses.has_prev %}
    <li class="page-item"><a class="page-link" href="{{ url_for('admin.nurses', page=nurses.prev_num) }}">Previous</a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Previous</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Page {{ nurses.page }} of {{ nurses.pages }}</span></li>
    {% if nurses.has_next %}
    <li class="page-item"><a class="page-link" href="{{ url_for('admin.nurses', page=nurses.next_num) }}">Next</a></li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}
  </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var buttons = document.querySelectorAll('.assigned-doctors-btn');
  buttons.forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var nurseId = btn.getAttribute('data-nurse-id');

      // If already loaded, toggle existing popover
      if (btn._loaded) {
        var existing = bootstrap.Popover.getInstance(btn);
        if (existing) existing.toggle();
        return;
      }

      fetch('{{ url_for("admin.api_get_assigned_doctors", nurse_id=0) }}'.replace('0', nurseId))
        .then(function(res){ if(!res.ok) throw new Error(res.statusText); return res.json(); })
        .then(function(data){
          var html = '';
          if (data.doctors && data.doctors.length) {
            html = '<ul class="list-unstyled mb-0">';
            data.doctors.forEach(function(d){ html += '<li>' + d.name + '</li>'; });
            html += '</ul>';
          } else {
            html = '<div class="text-muted">No doctors assigned.</div>';
          }

          // Create and show popover (uses Bootstrap popover)
          var pop = new bootstrap.Popover(btn, {
            content: html,
            html: true,
            placement: 'left',
            trigger: 'focus'
          });
          btn._loaded = true;
          pop.show();
        })
        .catch(function(err){
          console.error(err);
          var pop = new bootstrap.Popover(btn, {
            content: '<div class="text-danger">Failed to load</div>',
            html: true,
            placement: 'left',
            trigger: 'focus'
          });
          pop.show();
        });
    });
  });
});
</script>
{% endblock %}